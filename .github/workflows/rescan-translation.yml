name: Build Custom Pinyin Dictionary

on:
  workflow_dispatch:   # 手动触发
  push:
    branches: [ main ] # 或根据需要修改分支

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget tar libime-bin

      - name: Get latest release tag
        id: get_latest
        run: |
          latest_tag=$(curl -s https://api.github.com/repos/wuhgit/CustomPinyinDictionary/releases/latest | grep tag_name | cut -d '"' -f4)
          echo "tag=$latest_tag" >> $GITHUB_OUTPUT

      - name: Download release file
        run: |
          wget -q "https://github.com/wuhgit/CustomPinyinDictionary/releases/download/${{ steps.get_latest.outputs.tag }}/CustomPinyinDictionary_Fcitx_${{ steps.get_latest.outputs.tag }}.tar.gz"

      - name: Extract dictionary
        run: |
          tar -xzf CustomPinyinDictionary_Fcitx_${{ steps.get_latest.outputs.tag }}.tar.gz
          ls -lh

      - name: Convert dictionary
        run: |
          libime_pinyindict -d CustomPinyinDictionary_Fcitx.dict CustomPinyinDictionary_Fcitx.txt

      - name: Upload converted file
        uses: actions/upload-artifact@v4
        with:
          name: converted-dict
          path: CustomPinyinDictionary_Fcitx.txt
